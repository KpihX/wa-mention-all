stages:
  - deploy

deploy_homelab:
  stage: deploy
  tags:
    - homelab 
  only:
    - main     # Se lance uniquement quand on push sur la branche main
  script:
    - echo "üöÄ D√©marrage du d√©ploiement sur le Homelab..."
    
    # 1. On recr√©e le fichier .env avec les secrets stock√©s dans GitLab
    - echo "ALLOWED_IDS=$ALLOWED_IDS" >> .env
    - echo "THROTTLE_FEEDBACK=2" >> .env
    - echo "THROTTLE_FEEDBACK=0" >> .env
    
    # On ajoute le proxy (h√©rit√© des variables de groupe si configur√©, sinon on le force ici par s√©curit√©)
    # - echo "http_proxy=http://129.104.201.11:8080" >> .env
    # - echo "https_proxy=http://129.104.201.11:8080" >> .env
    
    # 2. Lancement de Docker Compose
    # Le runner ex√©cute √ßa directement sur ton serveur
    - docker compose up -d --build --remove-orphans --force-recreate
    
    # 3. Nettoyage des vieilles images pour ne pas saturer le disque
    - docker image prune -f
    
    - echo "‚úÖ D√©ploiement termin√© ! Application accessible."